WITH agg_query AS (SELECT w.huc_12, array_agg(ap_id) AS ap_ids FROM avaricosa_polygon a, nhd_hu12_watersheds w WHERE contains_avaricosa = 'Y' AND ST_Intersects(a.geom, w.geom) GROUP BY w.huc_12) INSERT INTO nhd_hu12_watersheds_avaricosa_relation (huc_12, avaricosa_source_geom, avaricosa_ap_id) (SELECT huc_12, 'polygon', ap_ids FROM agg_query);
WITH agg_query AS (SELECT w.huc_12, array_agg(ap_id) AS ap_ids FROM avaricosa_point a, nhd_hu12_watersheds w WHERE contains_avaricosa = 'Y' AND ST_Intersects(a.geom, w.geom) GROUP BY w.huc_12) INSERT INTO nhd_hu12_watersheds_avaricosa_relation (huc_12, avaricosa_source_geom, avaricosa_ap_id) (SELECT huc_12, 'point', ap_ids FROM agg_query);
WITH agg_query AS (SELECT w.huc_12, array_agg(ap_id) AS ap_ids FROM avaricosa_line a, nhd_hu12_watersheds w WHERE contains_avaricosa = 'Y' AND ST_Intersects(a.geom, w.geom) GROUP BY w.huc_12) INSERT INTO nhd_hu12_watersheds_avaricosa_relation (huc_12, avaricosa_source_geom, avaricosa_ap_id) (SELECT huc_12, 'line', ap_ids FROM agg_query);